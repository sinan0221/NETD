<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Student</title>
    <link rel="stylesheet" href="/stylesheets/sform.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="left-head"></div>
            <div class="right-head"></div>
        </div>
       
        <div class="full-width-image-container"></div>
        
        <div class="content">
            <div class="page1">
                <img src="/images/title.jpg" alt="Title" class="full-width-image" />
                
                <div class="heading-wrapper">
                    <h2 class="main-heading">CANDIDATE ADMISSION-CUM-EXAMINATION FORM</h2>
                </div>

                <h3>Note: All entries must be filled by the candidate in capital letters</h3>
                
                <form id="studentForm" action="/user/update-student/{{student._id}}" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="centreId" value="{{student.centreId}}">

                    <!-- Academic Details -->
                    <h2><i class="fa-solid fa-building-columns"></i> Academic Details</h2>

                    <div class="form-row">
                        <div class="form-group" style="padding-top: 100px;">
                            <label>Admission Year</label>
                            <input type="text" name="admissionYear" placeholder="eg:2024-2025" value="{{student.admissionYear}}">
                        </div>
                        <div class="form-group" style="padding-top: 100px;">
                            <label>Mode</label>
                            <select name="mode">
                                <option value="">select</option>
                                <option value="Regular" {{#ifEquals student.mode "Regular"}}selected{{/ifEquals}}>Regular</option>
                                <option value="Distance" {{#ifEquals student.mode "Distance"}}selected{{/ifEquals}}>Distance</option>
                                <option value="Online" {{#ifEquals student.mode "Online"}}selected{{/ifEquals}}>Online</option>
                            </select>
                        </div>
                        <div class="photo-box">
                            <label for="imageUpload" class="photo-label">Student Photo</label>
                            <input type="file" accept="image/*" id="imageUpload" name="image" onchange="previewPhoto(event)" style="display: none;">
                            <div class="photo-preview" id="photoPreviewBox">
                                {{#if student._id}}
                                    <img id="previewImage" src="/studentImages/{{student._id}}.jpg" alt="Student Photo" 
                                         style="max-width: 100%; max-height: 100%;" 
                                         onerror="this.src='/images/default-avatar.jpg'">
                                {{else}}
                                    <img id="previewImage" src="/images/default-avatar.jpg" alt="Photo Upload" style="max-width: 100%; max-height: 100%;">
                                {{/if}}
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ATC (Centre)</label>
                            <input
  type="text"
  name="centreId"
  value="{{splitFirst student.centreId}}"
  readonly
  style="background:#f5f5f5;"
>

                            
                        </div>
                        <div class="form-group">
                            <label>Course Name</label>
                            <select name="courseName" class="form-control" required>
                                <option value="">-- Select Course --</option>
                                {{#each courseNames}}
                                    <option value="{{this}}" {{#ifEquals ../student.courseName this}}selected{{/ifEquals}}>{{this}}</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Course Code</label>
                            <input type="text" name="courseCode" value="{{student.courseCode}}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Short Name</label>
                            <input type="text" name="shortName" value="{{student.shortName}}">
                        </div>
                        <div class="form-group">
                            <label>Course Duration</label>
                            <input type="text" name="courseDuration" value="{{student.courseDuration}}">
                        </div>
                        <div class="form-group">
                            <label>Medium</label>
                            <input type="text" name="medium" value="{{student.medium}}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Course Department</label>
                            <select name="department" id="department">
                                <option value="">Select Department</option>
                                <!-- Check student department first -->
                                {{#if student.department}}
                                    <option value="{{student.department}}" selected>{{student.department}}</option>
                                {{else}}
                                    <!-- Then check center department -->
                                    {{#if centre.department}}
                                        <option value="{{centre.department}}">{{centre.department}}</option>
                                    {{/if}}
                                {{/if}}
                                <!-- Default options -->
                                <option value="Department of Paramedical Education">Department of Paramedical Education</option>
                                <option value="Mobile Phone Technology">Mobile Phone Technology</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="batchId">Admission Batch</label>
                            <select name="batchId" id="batchId" required>
                                <option value="">Select Batch</option>
                                {{#each batches}}
                                    <option value="{{this._id}}" 
                                        {{#if ../student.batchId}}
                                            {{#ifEquals (toString ../student.batchId) (toString this._id)}}
                                                selected
                                            {{/ifEquals}}
                                        {{/if}}>
                                        {{this.batchName}} ({{this.batchId}})
                                    </option>
                                {{/each}}
                            </select>
                        </div>
                    </div>

                    <!-- Personal Details -->
                    <h2><i class="fa-solid fa-circle-user"></i> Personal Details</h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Student Reg. No.</label>
                            <input type="text" name="regNo" value="{{student.regNo}}">
                        </div>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" name="fullName" value="{{student.fullName}}">
                        </div>
                        <div class="form-group">
                            <label>Mother Name</label>
                            <input type="text" name="motherName" value="{{student.motherName}}">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Father Name</label>
                            <input type="text" name="fatherName" value="{{student.fatherName}}">
                        </div>
                        <div class="form-group">
                            <label>Father Occupation</label>
                            <input type="text" name="fatherOcc" value="{{student.fatherOcc}}">
                        </div>
                        <div class="form-group">
                            <label>Candidate Occupation</label>
                            <input type="text" name="candOcc" value="{{student.candOcc}}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Gender</label>
                            <select name="gender">
                                <option value="">select</option>
                                <option value="Male" {{#ifEquals student.gender "Male"}}selected{{/ifEquals}}>Male</option>
                                <option value="Female" {{#ifEquals student.gender "Female"}}selected{{/ifEquals}}>Female</option>
                                <option value="Other" {{#ifEquals student.gender "Other"}}selected{{/ifEquals}}>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            {{#if student.dob}}
                                <input type="date" name="dob" value="{{formatDateISO student.dob}}">
                            {{else}}
                                <input type="date" name="dob" value="">
                            {{/if}}
                        </div>
                        <div class="form-group">
                            <label>Contact Number</label>
                            <input type="number" name="number" value="{{student.number}}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Emergency Number</label>
                            <input type="number" name="emerNum" value="{{student.emerNum}}">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email" value="{{student.email}}">
                        </div>
                        <div class="form-group">
                            <label>BPL</label>
                            <select name="bpl">
                                <option value="">select</option>
                                <option value="Yes" {{#ifEquals student.bpl "Yes"}}selected{{/ifEquals}}>Yes</option>
                                <option value="No" {{#ifEquals student.bpl "No"}}selected{{/ifEquals}}>No</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>PH</label>
                            <select name="ph">
                                <option value="">select</option>
                                <option value="Yes" {{#ifEquals student.ph "Yes"}}selected{{/ifEquals}}>Yes</option>
                                <option value="No" {{#ifEquals student.ph "No"}}selected{{/ifEquals}}>No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Caste Category</label>
                            <select name="caste">
                                <option value="">select category</option>
                                <option value="Gen" {{#ifEquals student.caste "Gen"}}selected{{/ifEquals}}>Gen</option>
                                <option value="OBC" {{#ifEquals student.caste "OBC"}}selected{{/ifEquals}}>OBC</option>
                                <option value="SC" {{#ifEquals student.caste "SC"}}selected{{/ifEquals}}>SC</option>
                                <option value="ST" {{#ifEquals student.caste "ST"}}selected{{/ifEquals}}>ST</option>
                                <option value="Other" {{#ifEquals student.caste "Other"}}selected{{/ifEquals}}>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Aadhar Number</label>
                            <input type="number" name="adharNo" value="{{student.adharNo}}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" name="address" value="{{student.address}}">
                        </div>
                        <div class="form-group">
                            <label>Pin Code</label>
                            <input type="number" name="pinCode" value="{{student.pinCode}}">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" name="city" value="{{student.city}}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>District</label>
                            <input type="text" name="district" value="{{student.district}}">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" name="state" value="{{student.state}}">
                        </div>
                        <div class="form-group">
                            <label>Nationality</label>
                            <input type="text" name="nationality" value="{{student.nationality}}">
                        </div>
                    </div>
                </div>
                
                <div class="page-break"></div>
                
                <div id="page2" style="padding: 20px; font-family: Arial, sans-serif; margin-top: 30px;" class="page2">
                    <!-- Qualification Details -->
                    <h2><i class="fa-solid fa-medal"></i> Qualification Details</h2>
                    <div class="table-container">
                        <table class="qualification-table">
                            <thead>
                                <tr>
                                    <th>Education</th>
                                    <th>Max Marks</th>
                                    <th>Min Marks</th>
                                    <th>Obtained Marks</th>
                                    <th>Grade-%</th>
                                    <th>Year</th>
                                    <th>Board/University/Organisation</th>
                                </tr>
                            </thead>
                            <tbody id="qualificationBody">
                                {{#if student.qualifications}}
                                    {{#each student.qualifications}}
                                    <tr>
                                        <td>
                                            <input type="text" name="education[]" value="{{this.education}}" readonly style="background: #f5f5f5; border: none;">
                                        </td>
                                        <td><input type="number" name="maxMarks[]" placeholder="100" value="{{this.maxMarks}}"></td>
                                        <td><input type="number" name="minMarks[]" placeholder="33" value="{{this.minMarks}}"></td>
                                        <td><input type="number" name="obtainedMarks[]" placeholder="Obtained" value="{{this.obtainedMarks}}"></td>
                                        <td><input type="text" name="grade[]" placeholder="A/90%" value="{{this.grade}}"></td>
                                        <td><input type="number" name="year[]" placeholder="YYYY" value="{{this.year}}"></td>
                                        <td><input type="text" name="board[]" placeholder="Board name" value="{{this.board}}"></td>
                                    </tr>
                                    {{/each}}
                                {{else}}
                                    <!-- If no qualifications in database, show default rows -->
                                    <tr>
                                        <td><input type="text" name="education[]" value="Under Class 10" readonly style="background: #f5f5f5; border: none;"></td>
                                        <td><input type="number" name="maxMarks[]" placeholder="100"></td>
                                        <td><input type="number" name="minMarks[]" placeholder="33"></td>
                                        <td><input type="number" name="obtainedMarks[]" placeholder="Obtained"></td>
                                        <td><input type="text" name="grade[]" placeholder="A/90%"></td>
                                        <td><input type="number" name="year[]" placeholder="YYYY"></td>
                                        <td><input type="text" name="board[]" placeholder="Board name"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" name="education[]" value="Class 10/SSC" readonly style="background: #f5f5f5; border: none;"></td>
                                        <td><input type="number" name="maxMarks[]" placeholder="100"></td>
                                        <td><input type="number" name="minMarks[]" placeholder="33"></td>
                                        <td><input type="number" name="obtainedMarks[]" placeholder="Obtained"></td>
                                        <td><input type="text" name="grade[]" placeholder="A/90%"></td>
                                        <td><input type="number" name="year[]" placeholder="YYYY"></td>
                                        <td><input type="text" name="board[]" placeholder="Board name"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" name="education[]" value="Class 12 VHSC" readonly style="background: #f5f5f5; border: none;"></td>
                                        <td><input type="number" name="maxMarks[]" placeholder="100"></td>
                                        <td><input type="number" name="minMarks[]" placeholder="33"></td>
                                        <td><input type="number" name="obtainedMarks[]" placeholder="Obtained"></td>
                                        <td><input type="text" name="grade[]" placeholder="A/90%"></td>
                                        <td><input type="number" name="year[]" placeholder="YYYY"></td>
                                        <td><input type="text" name="board[]" placeholder="University name"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" name="education[]" value="Graduate ..." readonly style="background: #f5f5f5; border: none;"></td>
                                        <td><input type="number" name="maxMarks[]" placeholder="100"></td>
                                        <td><input type="number" name="minMarks[]" placeholder="33"></td>
                                        <td><input type="number" name="obtainedMarks[]" placeholder="Obtained"></td>
                                        <td><input type="text" name="grade[]" placeholder="A/90%"></td>
                                        <td><input type="number" name="year[]" placeholder="YYYY"></td>
                                        <td><input type="text" name="board[]" placeholder="University name"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" name="education[]" value="PG/ Master......" readonly style="background: #f5f5f5; border: none;"></td>
                                        <td><input type="number" name="maxMarks[]" placeholder="100"></td>
                                        <td><input type="number" name="minMarks[]" placeholder="33"></td>
                                        <td><input type="number" name="obtainedMarks[]" placeholder="Obtained"></td>
                                        <td><input type="text" name="grade[]" placeholder="A/90%"></td>
                                        <td><input type="number" name="year[]" placeholder="YYYY"></td>
                                        <td><input type="text" name="board[]" placeholder="University name"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" name="education[]" value="Other...." readonly style="background: #f5f5f5; border: none;"></td>
                                        <td><input type="number" name="maxMarks[]" placeholder="100"></td>
                                        <td><input type="number" name="minMarks[]" placeholder="33"></td>
                                        <td><input type="number" name="obtainedMarks[]" placeholder="Obtained"></td>
                                        <td><input type="text" name="grade[]" placeholder="A/90%"></td>
                                        <td><input type="number" name="year[]" placeholder="YYYY"></td>
                                        <td><input type="text" name="board[]" placeholder="University name"></td>
                                    </tr>
                                {{/if}}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <br>
                <div class="form-row">
                    <button class="submit-btn" type="submit">Update Student</button>
                   
                </div>
            </form>
        </div>
    </div>

    <script>
        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById("previewImage").src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Trigger file input when clicking the preview box
        document.getElementById('photoPreviewBox').addEventListener('click', function() {
            document.getElementById('imageUpload').click();
        });

        // Fix date format on page load
        document.addEventListener('DOMContentLoaded', function() {
            // If date input is empty but we have student.dob value, try to format it
            const dobInput = document.querySelector('input[name="dob"]');
            if (!dobInput.value && "{{student.dob}}") {
                const rawDate = "{{student.dob}}";
                if (rawDate) {
                    try {
                        // Try to parse and format the date
                        const date = new Date(rawDate);
                        if (!isNaN(date.getTime())) {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            dobInput.value = `${year}-${month}-${day}`;
                        }
                    } catch (e) {
                        console.log("Could not parse date:", rawDate);
                    }
                }
            }
        });
    </script>
</body>
</html>