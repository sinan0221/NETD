<style>
  /* Color Theme */
  :root {
    --dark-blue: rgba(0, 78, 137, 1);
    --dark-blue-light: rgba(0, 78, 137, 0.95);
    --golden-brown: rgba(176, 149, 114, 1);
    --golden-brown-light: rgba(176, 149, 114, 0.9);
    --white: #ffffff;
    --light-gray: #f8f9fa;
    --medium-gray: #e9ecef;
    --text-dark: #333333;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Custom styling for the form */
  .form-container {
    background: linear-gradient(135deg, var(--light-gray) 0%, var(--medium-gray) 100%);
    min-height: 100vh;
    padding: 2rem 0;
  }
  
  .card-header {
    background: linear-gradient(135deg, var(--dark-blue) 0%, var(--dark-blue-light) 100%);
    border-bottom: none;
  }
  
  .card {
    border: none;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: var(--shadow);
    transition: var(--transition);
  }
  
  .card:hover {
    box-shadow: var(--shadow-hover);
  }
  
  .card-body {
    background: var(--white);
    padding: 2rem;
  }
  
  .form-label {
    color: var(--dark-blue) !important;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .form-control, .form-select {
    border: 2px solid var(--medium-gray);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    transition: var(--transition);
    background-color: var(--white);
    color: var(--text-dark) !important;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: var(--dark-blue);
    box-shadow: 0 0 0 0.25rem rgba(0, 78, 137, 0.25);
    color: var(--text-dark);
  }
  
  .form-control::placeholder {
    color: #888;
  }
  
  .input-group-text {
    background-color: var(--light-gray);
    border: 2px solid var(--medium-gray);
    color: var(--dark-blue);
    border-right: none;
  }
  
  .btn-success {
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: var(--transition);
  }
  
  .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
  }
  
  .btn-secondary {
    background: linear-gradient(135deg, var(--golden-brown) 0%, var(--golden-brown-light) 100%);
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: var(--transition);
    color: var(--white);
  }
  
  .btn-secondary:hover {
    background: linear-gradient(135deg, var(--golden-brown-light) 0%, var(--golden-brown) 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(176, 149, 114, 0.3);
  }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--dark-blue) 0%, var(--dark-blue-light) 100%);
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-weight: 600;
    transition: var(--transition);
    color: var(--white);
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, var(--dark-blue-light) 0%, var(--dark-blue) 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 78, 137, 0.3);
  }
  
  .btn-warning {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-weight: 600;
    transition: var(--transition);
    color: var(--white);
  }
  
  .btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(230, 126, 34, 0.3);
  }
  
  .btn-danger {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-weight: 600;
    transition: var(--transition);
  }
  
  .alert {
    border: none;
    border-radius: 10px;
    padding: 1rem 1.25rem;
  }
  
  .alert-success {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
    border-left: 4px solid #28a745;
  }
  
  .alert-danger {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
    border-left: 4px solid #dc3545;
  }
  
  .alert-warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
    border-left: 4px solid #f39c12;
  }
  
  .form-text {
    color: #6c757d !important;
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }
  
  /* File upload custom styling - DISABLED STYLE */
  .file-upload-disabled {
    opacity: 0.6;
    cursor: not-allowed !important;
    position: relative;
  }
  
  .file-upload-disabled::before {
    content: "Coming Soon";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--golden-brown);
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    z-index: 10;
  }
  
  .file-upload-disabled input {
    cursor: not-allowed !important;
  }
  
  input[type="file"] {
    padding: 0.5rem;
  }
  
  input[type="file"]::file-selector-button {
    background: linear-gradient(135deg, var(--dark-blue) 0%, var(--dark-blue-light) 100%);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    margin-right: 1rem;
    cursor: pointer;
    transition: var(--transition);
  }
  
  input[type="file"]::file-selector-button:hover {
    background: linear-gradient(135deg, var(--dark-blue-light) 0%, var(--dark-blue) 100%);
  }
  
  /* Required field asterisk */
  .required::after {
    content: " *";
    color: #e74c3c;
  }
  
  /* Section styling */
  .section-item {
    background: var(--light-gray);
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 5px solid var(--dark-blue);
    transition: var(--transition);
    box-shadow: var(--shadow);
  }
  
  .section-item:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-hover);
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--medium-gray);
  }
  
  .section-title {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .section-number {
    background: var(--dark-blue);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  
  .section-name-input {
    background: transparent;
    border: 2px solid var(--medium-gray);
    border-radius: 6px;
    padding: 0.5rem 1rem;
    font-weight: 600;
    color: var(--dark-blue);
    min-width: 200px;
  }
  
  .section-name-input:focus {
    outline: none;
    border-color: var(--dark-blue);
  }
  
  .section-details {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }
  
  .section-detail {
    display: flex;
    flex-direction: column;
    min-width: 150px;
  }
  
  .section-detail label {
    font-size: 0.875rem;
    color: #666;
    margin-bottom: 0.25rem;
  }
  
  .section-detail input {
    padding: 0.5rem;
    border: 1px solid var(--medium-gray);
    border-radius: 4px;
  }
  
  .section-questions {
    margin-top: 1rem;
  }
  
  .question-item {
    background: var(--white);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 3px solid var(--golden-brown);
    transition: var(--transition);
  }
  
  .question-item:hover {
    background: var(--light-gray);
  }
  
  .question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  
  .question-number {
    font-weight: 700;
    color: var(--dark-blue);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .question-number-badge {
    background: var(--golden-brown);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.875rem;
  }
  
  /* Add question button within section */
  .add-question-btn {
    background: var(--medium-gray);
    border: 2px dashed var(--dark-blue);
    color: var(--dark-blue);
    border-radius: 6px;
    padding: 0.5rem 1rem;
    width: 100%;
    font-weight: 600;
    transition: var(--transition);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .add-question-btn:hover {
    background: rgba(0, 78, 137, 0.1);
  }
  
  /* Section actions */
  .section-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  /* Input method selection */
  .input-method-tabs {
    display: flex;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 1.5rem;
    border: 2px solid var(--medium-gray);
    background: var(--light-gray);
  }
  
  .method-tab {
    flex: 1;
    padding: 0.75rem;
    text-align: center;
    background: var(--light-gray);
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-dark);
  }
  
  .method-tab.active {
    background: var(--dark-blue);
    color: white;
  }
  
  .method-tab:not(.active):hover {
    background: var(--medium-gray);
  }
  
  .method-tab.disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }
  
  .method-content {
    display: none;
  }
  
  .method-content.active {
    display: block;
  }
  
  /* Sections container */
  #sectionsContainer {
    max-height: 500px;
    overflow-y: auto;
    padding-right: 10px;
  }
  
  #sectionsContainer::-webkit-scrollbar {
    width: 8px;
  }
  
  #sectionsContainer::-webkit-scrollbar-track {
    background: var(--light-gray);
    border-radius: 4px;
  }
  
  #sectionsContainer::-webkit-scrollbar-thumb {
    background: var(--golden-brown);
    border-radius: 4px;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .card-body {
      padding: 1.5rem;
    }
    
    .section-details {
      flex-direction: column;
    }
    
    .section-detail {
      min-width: 100%;
    }
    
    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .input-method-tabs {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
      margin-bottom: 0.5rem;
    }
  }
</style>

<section class="form-container">
  <div class="container">
    <div class="card shadow-lg">
      <!-- Card Header -->
      <div class="card-header text-white">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
          <div>
            <h4 class="mb-1"><i class="fas fa-file-alt me-2"></i>Submit Question Paper</h4>
            <p class="mb-0 text-light opacity-75">
              <i class="fas fa-users me-1"></i> Batch: {{batch.batchName}} ({{batch.batchId}})
            </p>
          </div>
          <a href="/user/view-question-papers/{{batch._id}}" class="btn btn-outline-light btn-sm mt-2 mt-md-0">
            <i class="fas fa-list me-1"></i> View All Papers
          </a>
        </div>
      </div>

      <!-- Card Body -->
      <div class="card-body">
        <!-- Success/Error Messages -->
        {{#if success}}
        <div class="alert alert-success alert-dismissible fade show d-flex align-items-center mb-4" role="alert">
          <i class="fas fa-check-circle fa-lg me-3"></i>
          <div class="flex-grow-1">{{success}}</div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {{/if}}
        
        {{#if error}}
        <div class="alert alert-danger alert-dismissible fade show d-flex align-items-center mb-4" role="alert">
          <i class="fas fa-exclamation-circle fa-lg me-3"></i>
          <div class="flex-grow-1">{{error}}</div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {{/if}}

        <!-- Alert for disabled feature -->
        <div class="alert alert-warning alert-dismissible fade show d-flex align-items-center mb-4" role="alert">
          <i class="fas fa-exclamation-triangle fa-lg me-3"></i>
          <div class="flex-grow-1">
            <strong>Note:</strong> File upload feature is temporarily disabled. Please use the manual input method to create question papers.
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Form -->
        <form action="/user/add-question-paper/{{batch._id}}" 
              method="POST" 
              enctype="multipart/form-data"
              class="needs-validation" novalidate>
              <input type="hidden" name="inputMethod" id="inputMethod" value="manual">

          <input type="hidden" name="studentId" value="{{studentId}}">
          
         
          <div class="mb-4">
            <label class="form-label required">Title 1</label>
            <input type="text" name="qtitle1" class="form-control" 
                   placeholder="eg : Ist SEMESTER PUBLIC EXAMINATION-MARCH 2024" required>
          </div>
           <div class="mb-4">
            <label class="form-label required">Title 2</label>
            <input type="text" name="qtitle2" class="form-control" 
                   placeholder="eg : DIPLOMA IN PATIENT CARE (ONE YEAR/TWO YEAR)" required>
          </div>

          <!-- Department and Course -->
          <div class="mb-4">
            <label class="form-label">Course Department</label>
            <select name="department" id="department" class="form-select">
              <option value="" disabled {{#unless centre.department}}selected{{/unless}}>Select Department</option>
              {{#if centre.department}}
                <option value="{{centre.department}}" selected>{{centre.department}}</option>
              {{/if}}
              <option value="Department of Paramedical Education">Department of Paramedical Education</option>
              <option value="Mobile Phone Technology">Mobile Phone Technology</option>
            </select>
            <label class="form-label required">Course Name</label>
            <select name="courseName" class="form-select" required>
              <option value="" disabled selected>-- Select Course --</option>
              {{#each courseNames}}
                <option value="{{this}}">{{this}}</option>
              {{/each}}
              <option value="OTHER">Other</option>
            </select>
          </div>

          <!-- Subject Details -->
          <div class="mb-4">
            <label class="form-label required">Subject Name</label>
            <input type="text" name="subject" class="form-control" 
                   placeholder="Enter subject name" required>
          </div>
              <div class="mb-4">
            <label class="form-label required">question Paper Code</label>
            <input type="text" name="qpCode" class="form-control" 
                   placeholder="Enter Question Paper Code" required>
          </div>


          <!-- Exam Details -->
          <div class="row">
            <div class="col-md-6 mb-4">
              <label class="form-label required">Total Marks</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-percentage"></i></span>
                <input type="number" name="totalMarks" class="form-control" min="1" max="500" value="100" required>
                <span class="input-group-text">marks</span>
              </div>
            </div>
            
            <div class="col-md-6 mb-4">
              <label class="form-label">Duration (Minutes)</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-clock"></i></span>
                <input type="number" name="duration" class="form-control" min="1" value="30">
                <span class="input-group-text">Minutes</span>
              </div>
            </div>
          </div>

          <!-- Input Method Selection -->
          <div class="mb-4">
            <label class="form-label required">Question Input Method</label>
            <div class="input-method-tabs">
              <button type="button" class="method-tab disabled" data-method="file" onclick="showComingSoonAlert()">
                <i class="fas fa-file-upload me-2"></i>Upload Word File
              </button>
              <button type="button" class="method-tab active" data-method="manual">
                <i class="fas fa-keyboard me-2"></i>Manual Input
              </button>
            </div>
          </div>

          <!-- File Upload Method (Disabled) -->
          <div class="method-content" id="fileMethod">
            <div class="mb-4 file-upload-disabled">
              <label class="form-label required">Upload Question Paper</label>
              <input type="file"
                     name="questionFile"
                     class="form-control"
                     accept=".doc,.docx"
                     id="fileInput"
                     disabled>
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                Upload .doc or .docx file containing the question paper (Max size: 10MB)
                <span class="text-warning fw-bold"> - Currently Disabled</span>
              </div>
            </div>
          </div>

          <!-- Manual Input Method -->
          <div class="method-content active" id="manualMethod">
            <div class="mb-4">
              <label class="form-label required">Create Question Paper Structure</label>
              
              <!-- Sections Container -->
              <div id="sectionsContainer">
                <!-- Sections will be added here dynamically -->
              </div>
              
              <!-- Add Section Button -->
              <button type="button" class="btn btn-primary mt-3" id="addSectionBtn">
                <i class="fas fa-plus-circle me-2"></i>Add New Section
              </button>
              
              <!-- Hidden input to store sections JSON -->
              <input type="hidden" name="sectionsJson" id="sectionsJson">
              
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                Add sections (e.g., Section A, Section B) and questions within each section. Total marks will be calculated automatically.
              </div>
            </div>
          </div>

          <!-- Instructions -->
          <div class="mb-4">
            <label class="form-label">Special Instructions (Optional)</label>
            <textarea name="instructions" class="form-control" rows="3" 
                      placeholder="Any special instructions for students..."></textarea>
          </div>

          <!-- Form Actions -->
          <div class="d-flex flex-column flex-sm-row gap-3 mt-4 pt-3 border-top">
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save me-2"></i> Save Question Paper
            </button>
            <a href="/user/view-question-papers/{{batch._id}}" class="btn btn-secondary">
              <i class="fas fa-list me-2"></i> View Question Papers
            </a>
          </div>

        </form>
      </div>
    </div>
  </div>
</section>

<script>
// Global variables
let sections = [];
let sectionCounter = 1;

// Show coming soon alert for file upload
function showComingSoonAlert() {
  Swal.fire({
    title: 'Coming Soon!',
    text: 'File upload feature will be available in the next update. Please use manual input for now.',
    icon: 'info',
    confirmButtonColor: 'var(--dark-blue)',
    confirmButtonText: 'OK'
  });
}

// Template for section
function createSectionTemplate(sectionId, sectionNumber) {
  return `
    <div class="section-item" id="${sectionId}">
      <div class="section-header">
        <div class="section-title">
          <span class="section-number">${sectionNumber}</span>
          <input type="text" class="section-name-input" 
                 placeholder="Section Name (e.g., Section A)" 
                 value="Section ${String.fromCharCode(64 + sectionNumber)}">
        </div>
        <div class="section-actions">
          <button type="button" class="btn btn-warning btn-sm" onclick="addQuestionToSection('${sectionId}')">
            <i class="fas fa-plus me-1"></i> Add Question
          </button>
          <button type="button" class="btn btn-danger btn-sm" onclick="removeSection('${sectionId}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      
      <div class="section-details">
        <div class="section-detail">
          <label>Total Questions</label>
          <input type="number" class="section-total-questions" min="1" value="1">
        </div>
        <div class="section-detail">
          <label>Marks per Question</label>
          <input type="number" class="section-marks-per-question" min="1" value="1">
        </div>
        <div class="section-detail">
          <label>Attempt</label>
          <select class="section-attempt-select form-select">
            <option value="ALL">Answer All</option>
            <option value="ANY">Attempt Any</option>
            <option value="SPECIFIC">Specific Count</option>
          </select>
        </div>
        <div class="section-detail">
          <label>Instructions</label>
          <input type="text" class="section-instructions" placeholder="Optional instructions">
        </div>
      </div>
      
      <div class="section-questions" id="questions-${sectionId}">
        <!-- Questions will be added here -->
      </div>
      
      <button type="button" class="add-question-btn" onclick="addQuestionToSection('${sectionId}')">
        <i class="fas fa-plus"></i> Add Another Question
      </button>
    </div>
  `;
}

// Template for question
function createQuestionTemplate(questionId, questionNumber) {
  return `
    <div class="question-item" id="${questionId}">
      <div class="question-header">
        <div class="question-number">
          <span class="question-number-badge">Q${questionNumber}</span>
          Question ${questionNumber}
        </div>
        <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion('${questionId}')">
          <i class="fas fa-trash"></i>
        </button>
      </div>
      <div class="mb-3">
        <label class="form-label required">Question Text</label>
        <textarea class="form-control question-text" rows="3" placeholder="Enter the question text..." required></textarea>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label required">Marks</label>
          <input type="number" class="form-control question-marks" min="1" max="100" placeholder="Enter marks" required>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Question Type</label>
          <select class="form-select question-type">
            <option value="SHORT_ANSWER">Short Answer</option>
            <option value="LONG_ANSWER">Long Answer</option>
            <option value="MCQ">Multiple Choice</option>
            <option value="TRUE_FALSE">True/False</option>
            <option value="DESCRIPTIVE">Descriptive</option>
          </select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-12">
          <label class="form-label">Options (for MCQs)</label>
          <div class="options-container" id="options-${questionId}">
            <!-- Options will be added here -->
          </div>
          <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addOption('${questionId}')">
            <i class="fas fa-plus"></i> Add Option
          </button>
        </div>
      </div>
    </div>
  `;
}

// Template for option (for MCQs)
function createOptionTemplate(optionId, optionLetter) {
  return `
    <div class="option-item d-flex align-items-center mb-2" id="${optionId}">
      <span class="me-2 fw-bold">${optionLetter}.</span>
      <input type="text" class="form-control option-text" placeholder="Option text">
      <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeOption('${optionId}')">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;
}

document.addEventListener('DOMContentLoaded', function() {
  // Input method tabs
  const methodTabs = document.querySelectorAll('.method-tab:not(.disabled)');
  const methodContents = document.querySelectorAll('.method-content');
  
  // Tab switching functionality
  methodTabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const method = this.getAttribute('data-method');

      // Update hidden input for backend
      document.getElementById('inputMethod').value = method;

      // Update active tab
      methodTabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');

      // Show active content
      methodContents.forEach(content => {
        content.classList.remove('active');
        if (content.id === method + 'Method') {
          content.classList.add('active');
        }
      });
    });
  });

  // Add section functionality
  const addSectionBtn = document.getElementById('addSectionBtn');
  const sectionsContainer = document.getElementById('sectionsContainer');

  addSectionBtn.addEventListener('click', addSection);

  function addSection() {
    const sectionId = `section_${Date.now()}`;
    const sectionHTML = createSectionTemplate(sectionId, sectionCounter);
    
    sectionsContainer.insertAdjacentHTML('beforeend', sectionHTML);
    
    // Add first question to the section
    addQuestionToSection(sectionId);
    
    // Add event listeners to section inputs
    const sectionElement = document.getElementById(sectionId);
    const inputs = sectionElement.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      input.addEventListener('input', updateSectionsJson);
    });
    
    sectionCounter++;
    updateSectionsJson();
  }

  // Add question to section
  window.addQuestionToSection = function(sectionId) {
    const questionsContainer = document.getElementById(`questions-${sectionId}`);
    const questionId = `question_${Date.now()}`;
    
    // Count existing questions in this section
    const existingQuestions = questionsContainer.querySelectorAll('.question-item');
    const questionNumber = existingQuestions.length + 1;
    
    const questionHTML = createQuestionTemplate(questionId, questionNumber);
    questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
    
    // Add event listeners to question inputs
    const questionElement = document.getElementById(questionId);
    const inputs = questionElement.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      input.addEventListener('input', updateSectionsJson);
    });
    
    updateSectionsJson();
  };

  // Remove section
  window.removeSection = function(sectionId) {
    const sectionElement = document.getElementById(sectionId);
    if (sectionElement) {
      sectionElement.remove();
      updateSectionsJson();
    }
  };

  // Remove question
  window.removeQuestion = function(questionId) {
    const questionElement = document.getElementById(questionId);
    if (questionElement) {
      questionElement.remove();
      updateSectionsJson();
    }
  };

  // Add option to MCQ
  window.addOption = function(questionId) {
    const optionsContainer = document.getElementById(`options-${questionId}`);
    const optionId = `option_${Date.now()}`;
    
    // Count existing options
    const existingOptions = optionsContainer.querySelectorAll('.option-item');
    const optionLetter = String.fromCharCode(97 + existingOptions.length); // a, b, c, d...
    
    const optionHTML = createOptionTemplate(optionId, optionLetter);
    optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
    
    updateSectionsJson();
  };

  // Remove option
  window.removeOption = function(optionId) {
    const optionElement = document.getElementById(optionId);
    if (optionElement) {
      optionElement.remove();
      updateSectionsJson();
    }
  };

  // Update the sections JSON
  function updateSectionsJson() {
    const sectionElements = document.querySelectorAll('.section-item');
    sections = [];
    
    sectionElements.forEach((sectionElement, sectionIndex) => {
      const sectionName = sectionElement.querySelector('.section-name-input').value || `Section ${String.fromCharCode(65 + sectionIndex)}`;
      const totalQuestions = parseInt(sectionElement.querySelector('.section-total-questions').value) || 0;
      const marksPerQuestion = parseInt(sectionElement.querySelector('.section-marks-per-question').value) || 0;
      const attemptType = sectionElement.querySelector('.section-attempt-select').value;
      const instructions = sectionElement.querySelector('.section-instructions').value || '';
      
      // Collect questions in this section
      const questionElements = sectionElement.querySelectorAll('.question-item');
      const questions = [];
      
      questionElements.forEach((questionElement, qIndex) => {
        const text = questionElement.querySelector('.question-text').value;
        const marks = parseInt(questionElement.querySelector('.question-marks').value) || 0;
        const type = questionElement.querySelector('.question-type').value;
        
        // Collect options for MCQs
        const options = [];
        if (type === 'MCQ') {
          const optionElements = questionElement.querySelectorAll('.option-item');
          optionElements.forEach((optionElement, optIndex) => {
            const optionText = optionElement.querySelector('.option-text').value;
            if (optionText) {
              options.push({
                letter: String.fromCharCode(97 + optIndex),
                text: optionText
              });
            }
          });
        }
        
        if (text && marks > 0) {
          questions.push({
            questionNumber: qIndex + 1,
            text: text,
            marks: marks,
            type: type,
            options: options.length > 0 ? options : undefined
          });
        }
      });
      
      sections.push({
        sectionNumber: sectionIndex + 1,
        sectionName: sectionName,
        totalQuestions: totalQuestions,
        marksPerQuestion: marksPerQuestion,
        attemptType: attemptType,
        instructions: instructions,
        questions: questions
      });
    });
    
    document.getElementById('sectionsJson').value = JSON.stringify(sections);
    
    // Update total marks
    const totalMarks = sections.reduce((sum, section) => {
      return sum + section.questions.reduce((sectionSum, q) => sectionSum + q.marks, 0);
    }, 0);
    
    document.querySelector('input[name="totalMarks"]').value = totalMarks;
  }

  // Form submission validation
  const form = document.querySelector('form');
  form.addEventListener('submit', function(e) {
    updateSectionsJson();
    
    if (sections.length === 0) {
      e.preventDefault();
      Swal.fire({
        title: 'No Sections Added',
        text: 'Please add at least one section to the question paper.',
        icon: 'warning',
        confirmButtonColor: 'var(--dark-blue)',
        confirmButtonText: 'OK'
      });
      return;
    }
    
    // Check if any section has questions
    const hasQuestions = sections.some(section => section.questions.length > 0);
    if (!hasQuestions) {
      e.preventDefault();
      Swal.fire({
        title: 'No Questions Added',
        text: 'Please add at least one question to the question paper.',
        icon: 'warning',
        confirmButtonColor: 'var(--dark-blue)',
        confirmButtonText: 'OK'
      });
      return;
    }
  });

  // Add first section by default
  setTimeout(() => {
    addSection();
  }, 100);
});

// Initialize SweetAlert if not already loaded
if (typeof Swal === 'undefined') {
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
  document.head.appendChild(script);
}
</script>