<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Student</title>
    <link rel="stylesheet" href="/stylesheets/sform.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="left-head">
                <h2>NETD</h2>
            </div>
            <div class="right-head">
                <a href="/admin/view-student" class="btn btn-dark">Back</a>
            </div>
        </div>
        <div class="full-width-image-container">
            <img src="/images/title.jpg" alt="Title" class="full-width-image" />
        </div>
        <div class="content">
            <h2>Edit Candidate Admission-cum-Examination Form</h2>
            <h3>Note: All entries must be filled by the candidate in capital letters</h3>
            
            <form action="/admin/update-student/{{student._id}}" method="POST" enctype="multipart/form-data">
                <!-- Academic Details -->
                <h2><i class="fa-solid fa-building-columns"></i> Academic Details</h2>
                <div class="photo-box">
                    <label for="imageUpload" class="photo-label">Photo</label>
                    <input type="file" accept="image/*" id="imageUpload" name="image" onchange="previewPhoto(event)" style="display: none;">
                    <div class="photo-preview" id="photoPreviewBox">
                        {{#if student._id}}
                            <img id="previewImage" src="/studentImages/{{student._id}}.jpg" alt="Current Photo" 
                                 onerror="this.src=''" style="max-width: 100%; max-height: 100%;">
                        {{else}}
                            <img id="previewImage" src="" alt="Photo Preview" style="max-width: 100%; max-height: 100%;">
                        {{/if}}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Admission Year</label>
                        <input type="number" name="admissionYear" value="{{student.admissionYear}}">
                    </div>
                    <div class="form-group">
                        <label>Mode</label>
                        <select name="mode">
                            <option value="select">select</option>
                            <option value="Regular" {{#eq student.mode "Regular"}}selected{{/eq}}>Regular</option>
                            <option value="Distance" {{#eq student.mode "Distance"}}selected{{/eq}}>Distance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ATC (Centre)</label>
                        <input type="text" name="centreId" value="{{student.centreId}}" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Course Name</label>
                        <input type="text" name="courseName" value="{{student.courseName}}">
                    </div>
                    <div class="form-group">
                        <label>Course Code</label>
                        <input type="text" name="courseCode" value="{{student.courseCode}}">
                    </div>
                    <div class="form-group">
                        <label>Short Name</label>
                        <input type="text" name="shortName" value="{{student.shortName}}">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Course Duration</label>
                        <input type="text" name="courseDuration" value="{{student.courseDuration}}">
                    </div>
                    <div class="form-group">
                        <label>Medium</label>
                        <input type="text" name="medium" value="{{student.medium}}">
                    </div>
                    <div class="form-group">
                        <label for="batchId">Admission Batch</label>
                        <select name="batchId" id="batchId" required>
                            <option value="">Select</option>
                            {{#each batches}}
                                <option value="{{this._id}}" {{#eq this._id ../student.batchId}}selected{{/eq}}>
                                    {{this.batchName}} ({{this.batchId}})
                                </option>
                            {{/each}}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Course Department</label>
                        <select name="department" id="department">
                            <option value="">Select Department</option>
                            <option value="Department of Paramedical Education" {{#eq student.department "Department of Paramedical Education"}}selected{{/eq}}>Department of Paramedical Education</option>
                            <option value="Mobile Phone Technology" {{#eq student.department "Mobile Phone Technology"}}selected{{/eq}}>Mobile Phone Technology</option>
                        </select>
                    </div>
                </div>

                <!-- Personal Details -->
                <h2><i class="fa-solid fa-circle-user"></i> Personal Details</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label>Student Reg. No.</label>
                        <input type="text" name="regNo" value="{{student.regNo}}">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" name="fullName" value="{{student.fullName}}">
                    </div>
                    <div class="form-group">
                        <label>Mother Name</label>
                        <input type="text" name="motherName" value="{{student.motherName}}">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Father Name</label>
                        <input type="text" name="fatherName" value="{{student.fatherName}}">
                    </div>
                    <div class="form-group">
                        <label>Father Occupation</label>
                        <input type="text" name="fatherOcc" value="{{student.fatherOcc}}">
                    </div>
                    <div class="form-group">
                        <label>Candidate Occupation</label>
                        <input type="text" name="candOcc" value="{{student.candOcc}}">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Gender</label>
                        <select name="gender">
                            <option value="select">select</option>
                            <option value="Male" {{#eq student.gender "Male"}}selected{{/eq}}>Male</option>
                            <option value="Female" {{#eq student.gender "Female"}}selected{{/eq}}>Female</option>
                            <option value="Other" {{#eq student.gender "Other"}}selected{{/eq}}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" name="dob" value="{{formatDate student.dob 'YYYY-MM-DD'}}">
                    </div>
                    <div class="form-group">
                        <label>Contact Number</label>
                        <input type="number" name="number" value="{{student.number}}">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Emergency Number</label>
                        <input type="number" name="emerNum" value="{{student.emerNum}}">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" value="{{student.email}}">
                    </div>
                    <div class="form-group">
                        <label>BPL</label>
                        <select name="bpl">
                            <option value="select">select</option>
                            <option value="Yes" {{#eq student.bpl "Yes"}}selected{{/eq}}>Yes</option>
                            <option value="No" {{#eq student.bpl "No"}}selected{{/eq}}>No</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>PH</label>
                        <select name="ph">
                            <option value="select">select</option>
                            <option value="Yes" {{#eq student.ph "Yes"}}selected{{/eq}}>Yes</option>
                            <option value="No" {{#eq student.ph "No"}}selected{{/eq}}>No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Caste Category</label>
                        <select name="caste">
                            <option value="select category">select category</option>
                            <option value="Gen" {{#eq student.caste "Gen"}}selected{{/eq}}>Gen</option>
                            <option value="OBC" {{#eq student.caste "OBC"}}selected{{/eq}}>OBC</option>
                            <option value="SC" {{#eq student.caste "SC"}}selected{{/eq}}>SC</option>
                            <option value="ST" {{#eq student.caste "ST"}}selected{{/eq}}>ST</option>
                            <option value="Other" {{#eq student.caste "Other"}}selected{{/eq}}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Aadhar Number</label>
                        <input type="number" name="adharNo" value="{{student.adharNo}}">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" name="address" value="{{student.address}}">
                    </div>
                    <div class="form-group">
                        <label>Pin Code</label>
                        <input type="number" name="pinCode" value="{{student.pinCode}}">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" name="city" value="{{student.city}}">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>District</label>
                        <input type="text" name="district" value="{{student.district}}">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" name="state" value="{{student.state}}">
                    </div>
                    <div class="form-group">
                        <label>Nationality</label>
                        <input type="text" name="nationality" value="{{student.nationality}}">
                    </div>
                </div>

                <!-- Qualification Details -->
      <h2><i class="fa-solid fa-medal"></i> Qualification Details</h2>
      <div class="table-container">
        <table class="qualification-table">
  <thead>
    <tr>
      <th>Education</th>
      <th>Max Marks</th>
      <th>Min Marks</th>
      <th>Obtained Marks</th>
      <th>Grade-%</th>
      <th>Year</th>
      <th>Board/University/Organisation</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="qualificationBody">
    <tr>
      <td>
        <select name="education[]">
          <option value="">Select</option>
          <option value="10th">10th Standard</option>
          <option value="12th">12th Standard</option>
          <option value="diploma">Diploma</option>
          <option value="ug">Undergraduate</option>
          <option value="pg">Postgraduate</option>
        </select>
      </td>
      <td><input type="number" name="maxMarks[]" placeholder="0"></td>
      <td><input type="number" name="minMarks[]" placeholder="0"></td>
      <td><input type="number" name="obtainedMarks[]" placeholder="Obtained"></td>
      <td><input type="text" name="grade[]" placeholder="A/90%"></td>
      <td><input type="number" name="year[]" placeholder="YYYY"></td>
      <td><input type="text" name="board[]" placeholder="Board name"></td>
      <td>
        <button type="button" class="add-row-btn">
          <i class="fas fa-plus-circle"></i> Add
        </button>
      </td>
    </tr>
  </tbody>
</table>
      </div>

                <br>
                <input class="submit-btn" type="submit" value="Update Student">
                <button type="button" id="downloadPdf" class="btn btn-danger">Download as PDF</button>
            </form>
        </div>
    </div>

    <script>
       document.addEventListener("click", function (e) {
  if (e.target.closest(".add-row-btn")) {
    let tbody = document.getElementById("qualificationBody");
    let newRow = tbody.rows[0].cloneNode(true);

    // clear inputs
    newRow.querySelectorAll("input, select").forEach(el => el.value = "");

    // change button to remove
    let actionCell = newRow.querySelector("td:last-child");
    actionCell.innerHTML = `
      <button type="button" class="remove-row-btn">
        <i class="fas fa-minus-circle"></i> Remove
      </button>
    `;

    tbody.appendChild(newRow);
  }

  if (e.target.closest(".remove-row-btn")) {
    let row = e.target.closest("tr");
    row.remove();
  }
});

        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById("previewImage").src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Trigger file input when clicking the preview box
        document.getElementById('photoPreviewBox').addEventListener('click', function() {
            document.getElementById('imageUpload').click();
        });

        // PDF download functionality
        document.getElementById("downloadPdf").addEventListener("click", function () {
            const { jsPDF } = window.jspdf;

            let formElement = document.querySelector(".container");

            html2canvas(formElement, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL("image/png");
                const pdf = new jsPDF("p", "mm", "a4");

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                const imgWidth = pageWidth;
                const imgHeight = canvas.height * imgWidth / canvas.width;

                let position = 0;
                pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);

                pdf.save("student-form.pdf");
            });
        });
    </script>
</body>
</html>